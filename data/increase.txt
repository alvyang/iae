//未发版sql

//20181007发版
CREATE TABLE `tag_drug` (
  `tag_drug_id` varchar(50) NOT NULL,
	`drug_id` int(20) DEFAULT NULL COMMENT '药品id',
	`tag_id` int(20) DEFAULT NULL COMMENT '标签id',
  PRIMARY KEY (`tag_drug_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
SET FOREIGN_KEY_CHECKS = 1;
alter table tag_drug add tag_drug_deleta_flag varchar(10) DEFAULT '0' COMMENT '删除';
alter table tag_drug add tag_drug_group_id varchar(10) COMMENT '组id';

insert into tag_drug(tag_drug_id,drug_id,tag_id) select d.product_id,d.product_id,d.tag_ids from drugs d where d.tag_ids is not null and d.tag_ids != '';
update tag_drug set tag_drug_deleta_flag='0';
update tag_drug set tag_drug_group_id='1';

ALTER TABLE drugs DROP tag_ids;
ALTER TABLE tag DROP tag_quote_num;

alter table role drop foreign key role_ibfk_1;
alter table authority drop foreign key authority_ibfk_1;
alter table users drop foreign key users_ibfk_1;
alter table users drop foreign key users_ibfk_2;

alter table allot modify column allot_id varchar(50);
alter table allot modify column allot_group_id varchar(50);
alter table allot modify column allot_drug_id varchar(50);

alter table authority modify column authority_id varchar(50);
alter table authority modify column authority_parent_id varchar(50);

alter table bank_account modify column account_id varchar(50);
alter table bank_account modify column account_group_id varchar(50);

alter table bank_account_detail modify column account_detail_id varchar(50);
alter table bank_account_detail modify column account_id varchar(50);
alter table bank_account_detail modify column account_detail_group_id varchar(50);

alter table business modify column business_id varchar(50);
alter table business modify column business_group_id varchar(50);

alter table business_commission modify column commission_id varchar(50);
alter table business_commission modify column commission_hospital_id varchar(50);
alter table business_commission modify column commission_business varchar(50);

alter table contacts modify column contacts_id varchar(50);
alter table contacts modify column group_id varchar(50);

alter table drugs modify column product_id varchar(50);
alter table drugs modify column contacts_id varchar(50);
alter table drugs modify column group_id varchar(50);

alter table groups modify column group_id varchar(50);

alter table hospital_business_config modify column hb_config_id varchar(50);
alter table hospital_business_config modify column hb_business_id varchar(50);
alter table hospital_business_config modify column hb_hospital_id varchar(50);
alter table hospital_business_config modify column hb_group_id varchar(50);

alter table hospital_return_money modify column return_money_id varchar(50);
alter table hospital_return_money modify column return_money_group_id varchar(50);
alter table hospital_return_money modify column return_money_hospital varchar(50);
alter table hospital_return_money modify column return_money_business varchar(50);

alter table hospitals modify column hospital_id varchar(50);
alter table hospitals modify column group_id varchar(50);

alter table purchase modify column purchase_id varchar(50);
alter table purchase modify column group_id varchar(50);
alter table purchase modify column drug_id varchar(50);

alter table refunds modify column refunds_id varchar(50);
alter table refunds modify column sales_id varchar(50);
alter table refunds modify column purchases_id varchar(50);
alter table refunds modify column refunds_group_id varchar(50);

alter table role modify column role_id varchar(50);
alter table role modify column group_id varchar(50);

alter table sales modify column sale_id varchar(50);
alter table sales modify column group_id varchar(50);
alter table sales modify column hospital_id varchar(50);

alter table tag modify column tag_id varchar(50);
alter table tag modify column tag_group_id varchar(50);

alter table tag_drug modify column tag_drug_group_id varchar(50);

alter table users modify column id varchar(50);
alter table users modify column group_id varchar(50);
alter table users modify column role_id varchar(50);
//20180929发版sql
update drugs set product_type = '其它' where product_type = '普药';
update drugs set product_type = '高打' where product_type = '高打(底价)';

alter table drugs add product_basic_medicine varchar(10) COMMENT '是否基药';
alter table drugs add product_purchase_mode varchar(10) COMMENT '产品采购方式';
alter table drugs add tag_ids varchar(50) COMMENT '标签id';
alter table refunds add refunds_remark varchar(200) COMMENT '返款备注';

update drugs dd set dd.product_purchase_mode = (
	select temp.r from (
		select substring(d.remark,1,2) r,d.product_code from drugs d where d.delete_flag='0' and d.remark is not null and d.remark != ''
	) temp where temp.product_code = dd.product_code
)
update drugs dd set dd.product_basic_medicine = (
	select temp.r from (
		select substring(d.remark,3) r,d.product_code from drugs d where d.delete_flag='0' and d.remark is not null and d.remark != ''
	) temp where temp.product_code = dd.product_code
)
update drugs d set d.remark = ""

CREATE TABLE `tag` (
  `tag_id` int(20) NOT NULL AUTO_INCREMENT,
  `tag_name` varchar(50) DEFAULT NULL COMMENT '标签名称',
  `tag_quote_num` varchar(20) DEFAULT '0' COMMENT '标签引用次数',
  `tag_group_id` varchar(5) DEFAULT NULL COMMENT '标签组id',
  `tag_delete_flag` varchar(5) DEFAULT '0' COMMENT '删除',
  PRIMARY KEY (`tag_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
SET FOREIGN_KEY_CHECKS = 1;

INSERT INTO `authority` VALUES ('93', '标签管理', '标签管理', '2004', '/main/tag', '25', '0', '1', '2', '1');
INSERT INTO `authority` VALUES ('94', '查询', '查询', '20044', '/', '93', '0', '1', '3', '6'),('95', '删除', '删除', '20043', '/', '93', '0', '1', '3', '2'), ('96', '修改', '修改', '20042', '/', '93', '0', '1', '3', '3'), ('97', '新增', '新增', '20041', '/', '93', '0', '1', '3', '1');
INSERT INTO `authority` VALUES  ('98', '报表管理', '报表管理', '2001', '/main/report', '1', '0', '1', '2', '1');
INSERT INTO `authority` VALUES  ('99', '查询', '', '20011', '/', '98', '0', '1', '3', '6');


//20190920发版sql
INSERT INTO `authority` VALUES
('78', '商业提成管理', '商业提成管理', '20013', '/main/businesscommission', '71', '0', '1', '2', '1'),
('83', '医院回款管理', '医院回款管理', '20014', '/main/returnmoney', '71', '0', '1', '2', '1'),
('88', '商业管理', '商业管理', '2003', '/main/business', '25', '0', '1', '2', '1');
INSERT INTO `authority` VALUES
('79', '查询', '查询', '200134', '/', '78', '0', '1', '3', '6'),
('80', '修改', '修改', '200133', '/', '78', '0', '1', '3', '2'),
('81', '删除', '删除', '200132', '/', '78', '0', '1', '3', '2'),
('82', '新增', '新增', '200131', '/', '78', '0', '1', '3', '1'),
('84', '查询', '查询', '200144', '/', '83', '0', '1', '3', '6'),
('85', '修改', '修改', '200143', '/', '83', '0', '1', '3', '3'),
('86', '删除', '删除', '200142', '/', '83', '0', '1', '3', '2'),
('87', '新增', '新增', '200141', '/', '83', '0', '1', '3', '1'),
('89', '查询', '查询', '20034', '/', '88', '0', '1', '3', '6'),
('90', '删除', '删除', '20033', '/', '88', '0', '1', '3', '2'),
('91', '修改', '修改', '20032', '/', '88', '0', '1', '3', '3'),
('92', '新增', '新增', '20031', '/', '88', '0', '1', '3', '1');

CREATE TABLE `business` (
  `business_id` int(20) NOT NULL AUTO_INCREMENT,
  `business_name` varchar(50) DEFAULT NULL COMMENT '商业公司名称',
  `business_mark` varchar(100) DEFAULT NULL COMMENT '商业公司描述',
  `business_group_id` varchar(5) DEFAULT NULL COMMENT '组id',
  `business_delete_flag` varchar(5) DEFAULT '0' COMMENT '删除',
  PRIMARY KEY (`business_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
SET FOREIGN_KEY_CHECKS = 1;

insert into business(business_name) select d.product_business from drugs d where d.delete_flag='0' and d.product_business is not null group by d.product_business;

update business set business_group_id = '1';

update drugs d set d.product_business = (select bu.business_id from business bu where d.product_business = bu.business_name);

alter table sales add sale_tax_rate varchar(20) COMMENT '单据税率';
update sales s set s.sale_tax_rate = '0.17' where DATE_FORMAT(s.bill_date,'%Y-%m-%d') <= "2018-05-31";
update sales s set s.sale_tax_rate = '0.16' where DATE_FORMAT(s.bill_date,'%Y-%m-%d') >= "2018-06-01";

alter table drugs add product_tax_rate varchar(20) COMMENT '商品税率';
update drugs d set d.product_tax_rate = '0.16';

CREATE TABLE `hospital_business_config` (
  `hb_config_id` int(20)  NOT NULL AUTO_INCREMENT,
  `hb_start_time` datetime DEFAULT NULL COMMENT '成本计算开始时间',
  `hb_start_money` varchar(50) DEFAULT NULL COMMENT '期初未回款金额',
  `hb_fixed_rate` varchar(50) DEFAULT NULL COMMENT '固定成本率',
  `hb_floating_rate` varchar(50) DEFAULT NULL COMMENT '浮动成本率/月',
  `hb_business_id` int(20) DEFAULT NULL COMMENT '商业id',
  `hb_hospital_id` int(20) DEFAULT NULL COMMENT '医院id',
  `hb_group_id` varchar(5) DEFAULT NULL COMMENT '组id',
  `hb_delete_flag` varchar(5) DEFAULT '0' COMMENT '删除',
  PRIMARY KEY (`hb_config_id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
SET FOREIGN_KEY_CHECKS = 1;

CREATE TABLE `hospital_return_money` (
  `return_money_id` int(20)  NOT NULL AUTO_INCREMENT,
  `return_money_hospital` varchar(10)  DEFAULT NULL COMMENT '回款医院',
  `return_money_business` varchar(10)  DEFAULT NULL COMMENT '回款商业',
  `return_money_time` datetime DEFAULT NULL COMMENT '回款时间',
  `return_money` varchar(50) DEFAULT NULL COMMENT '回款金额',
  `return_money_delete_flag` varchar(5) DEFAULT '0' COMMENT '删除标识',
  `return_money_group_id` varchar(5) DEFAULT NULL COMMENT '组id',
  PRIMARY KEY (`return_money_id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
SET FOREIGN_KEY_CHECKS = 1;

CREATE TABLE `business_commission` (
  `commission_id` int(20) NOT NULL AUTO_INCREMENT,
  `commission_time` datetime DEFAULT NULL COMMENT '统计时间',
  `commission_hospital_id` int(20) DEFAULT NULL COMMENT '医院机构id',
  `commission_business` int(20) DEFAULT NULL COMMENT '医院机构id',
  `commission_fixed_rate` varchar(50) DEFAULT NULL COMMENT '固定成本率',
  `commission_floating_rate` varchar(50) DEFAULT NULL COMMENT '浮动成本率',
  `commission_delete_flag` varchar(5) DEFAULT '0' COMMENT '删除标识',
  `commission_group_id` varchar(5) DEFAULT NULL COMMENT '组id',
  PRIMARY KEY (`commission_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
SET FOREIGN_KEY_CHECKS = 1;
//20180908发版
alter table allot add allot_account_id int(20) COMMENT '返款账号';

insert into bank_account_detail(flag_id,account_id,account_detail_money,account_detail_time,account_detail_mark,account_detail_deleta_flag,account_detail_group_id)
select CONCAT('allot_',a.allot_id),a.allot_account_id,CONCAT("-",a.allot_return_money),a.allot_return_time,CONCAT(DATE_FORMAT(a.allot_time,'%Y-%m-%d'),a.allot_hospital,'调货（',a.allot_number,'）',d.product_common_name,'返款'),'0',1 from
allot a left join drugs d on a.allot_drug_id = d.product_id where a.allot_return_flag = '是';


insert into bank_account_detail(flag_id,account_id,account_detail_money,account_detail_time,account_detail_mark,account_detail_deleta_flag,account_detail_group_id)
select CONCAT('allot_',a.allot_id),a.allot_account_id,CONCAT("-",a.allot_return_money),a.allot_return_time,CONCAT(DATE_FORMAT(a.allot_time,'%Y-%m-%d'),a.allot_hospital,'调货（',a.allot_number,'）',d.product_common_name,'返款'),'1',1 from
allot a left join drugs d on a.allot_drug_id = d.product_id where a.allot_return_flag = '否' or a.allot_return_flag = '';

select CONCAT("update sales s set s.accounting_cost ='",s.accounting_cost,
"',s.cost_univalent='",s.cost_univalent,"',s.gross_profit ='",s.gross_profit,
"',s.real_gross_profit ='",s.real_gross_profit,"' where s.sale_id = '" ,s.sale_id,"';") from sales s

//20180830发版
INSERT INTO `authority` VALUES
('66', '银行账号管理', '银行账号管理', '20012', '/main/account', '71', '0', '1', '2', '1'),
('67', '查询', '查询', '200124', '/', '66', '0', '1', '3', '6'),
('68', '新增', '新增', '200121', '/', '66', '0', '1', '3', '1'),
('69', '删除', '删除', '200122', '/', '66', '0', '1', '3', '2'),
('70', '修改', '修改', '200123', '/', '66', '0', '1', '3', '3'),
('71', '财务管理', '财务管理', '2001', '/', '1', '0', '1', '1', '1'),
('72', '流水账管理', '流水账管理', '20011', '/main/accountdetail', '71', '0', '1', '2', '1'),
('73', '查询', '查询', '200114', '/', '72', '0', '1', '3', '6'),
('74', '修改', '修改', '200113', '/', '72', '0', '1', '3', '3'),
('75', '删除', '删除', '200112', '/', '72', '0', '1', '3', '2'),
('76', '新增', '新增', '200111', '/', '72', '0', '1', '3', '1'),
('77', '药品管理', '药品管理', '4001', '/', '1', '0', '1', '1', '1');

update authority a set a.authority_parent_id = '77' where a.authority_id in (36,41);

CREATE TABLE `bank_account` (
  `account_id` int(20) NOT NULL AUTO_INCREMENT,
  `account_number` varchar(50) DEFAULT NULL COMMENT '收款账号',
  `account_person` varchar(50) DEFAULT NULL COMMENT '持卡人',
  `account_group_id` int(20) DEFAULT NULL COMMENT '组id',
  `account_delete_flag` varchar(5) DEFAULT '0' COMMENT '删除标识',
  PRIMARY KEY (`account_id`)
) ENGINE=InnoDB AUTO_INCREMENT=35 DEFAULT CHARSET=utf8;

SET FOREIGN_KEY_CHECKS = 1;

insert into bank_account(account_number) select r.receiver from refunds r where r.receiver != '' group by r.receiver
update bank_account set account_group_id = '1'
update refunds r set r.receiver = (select b.account_id from bank_account b where r.receiver = b.account_number);

CREATE TABLE `bank_account_detail` (
  `account_detail_id` int(20) NOT NULL AUTO_INCREMENT,
  `account_detail_money` varchar(20) DEFAULT NULL COMMENT '金额',
  `account_detail_time` datetime DEFAULT NULL COMMENT '时间',
  `account_detail_mark` varchar(200) DEFAULT NULL COMMENT '详情',
  `account_id` int(20) DEFAULT NULL,
  `account_detail_deleta_flag` varchar(2) DEFAULT '0' COMMENT '删除标识',
  `account_detail_group_id` int(20) DEFAULT NULL COMMENT '组标识',
  `flag_id` int(20) DEFAULT NULL COMMENT '返款id',
  PRIMARY KEY (`account_detail_id`)
) ENGINE=InnoDB AUTO_INCREMENT=143 DEFAULT CHARSET=utf8;

SET FOREIGN_KEY_CHECKS = 1;

insert into bank_account_detail(flag_id,account_id,account_detail_money,account_detail_time,account_detail_mark)
select sr.sale_id,sr.receiver,sr.refunds_real_money,sr.refunds_real_time,CONCAT(DATE_FORMAT(sr.bill_date,'%Y-%m-%d'),'销售',d.product_common_name,'返款') mark from (
select r.receiver,r.refunds_real_money,r.refunds_real_time,s.product_code,s.bill_date,s.sale_id from sales s left join refunds r on s.sale_id = r.sales_id
where s.sale_return_flag='1' and r.refunds_real_time is not null and r.refunds_real_money is not null
) sr left join drugs d on d.product_code = sr.product_code where sr.receiver is not null

insert into bank_account_detail(flag_id,account_id,account_detail_money,account_detail_time,account_detail_mark)
select pr.purchase_id,pr.receiver,pr.refunds_real_money,pr.refunds_real_time,CONCAT(DATE_FORMAT(pr.make_money_time,'%Y-%m-%d'),'高打',d.product_common_name,'返款') from (
select r.receiver,r.refunds_real_money,p.make_money_time,r.refunds_real_time,p.drug_id,p.purchase_id from purchase p left join refunds r on p.purchase_id = r.purchases_id
where p.purchase_return_flag='2' and p.make_money_time is not null and r.refunds_real_time is not null and r.refunds_real_money is not null
) pr left join drugs d on pr.drug_id = d.product_id where pr.receiver is not null

update bank_account_detail ba set ba.account_detail_deleta_flag = '0',ba.account_detail_group_id = '1'

update bank_account_detail bad set bad.flag_id = concat('purchase_',bad.flag_id) where bad.account_detail_mark like '%高打%'

alter table bank_account_detail modify column flag_id varchar(30);

update bank_account_detail bad set bad.flag_id = concat('sale_',bad.flag_id) where bad.account_detail_mark like '%销售%'


#第一次发版
alter table drugs add gross_interest_rate varchar(20) ; # 毛利率
alter table drugs add accounting_cost varchar(20) ; # 核算成本

alter table drugs add product_return_statistics varchar(5) ; # 返款统计
update drugs set product_return_statistics = 3;
update drugs set product_return_statistics = 1 where product_type='佣金';
update drugs set product_return_statistics = 2 where product_type='高打' or product_type='高打(底价)';

alter table sales add sale_return_flag varchar(5) ;#//销售记录表，添加标识
update sales set sale_return_flag = 3;
update sales join drugs on sales.product_code = drugs.product_code set sales.sale_return_flag = 1 where drugs.product_type='佣金';
update sales join drugs on sales.product_code = drugs.product_code set sales.sale_return_flag = 2 where drugs.product_type='高打' or drugs.product_type='高打(底价)';

alter table purchase add purchase_return_flag varchar(5) ;
update purchase set purchase_return_flag = 2;


select c.contacts_name,d.* from drugs d  left join contacts c on d.contacts_id = c.contacts_id where d.delete_flag = '0' and product_business = '九州通' ORDER BY d.product_type desc,c.contacts_name desc into outfile '/var/lib/mysql-files/drugs.xls';
